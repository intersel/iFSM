/*
 Intersel 2013-2017
 @fileoverview : iFSM : a finite state machine with jQuery
 @see {@link https://github.com/intersel/iFSM}
 @author : Emmanuel Podvin - emmanuel.podvin@intersel.fr
 @version : 1.7.2
 -----------------------------------------------------------------------------------------
*/
(function(g){function A(a){function d(a){return a.replace(/\-([a-z])/gi,function(a,b){return b.toUpperCase()})}for(var f=" -moz- -webkit- -o- -ms- -khtml-".split(" "),e=document.documentElement,c=0;c<f.length;c++){var g=d(f[c]+a);"Ms"==g.substr(0,2)&&(g="m"+g.substr(1));if(g in e.style)return g}}function p(a,d,f){var e={};e.data=f;e.target=a;e.currentTarget=a;e.type=d;e.stopPropagation=function(){return!0};return e}var y=0,m=window.fsm_manager=function(a,d,f){y+=1;void 0==f&&(f=null);this.opts=jQuery.extend({},
{debug:!1,LogLevel:2,AlertError:!1,maxPushEvent:100,startEvent:"start",prefixFsmName:"FSM_",logFSM:""},f||{});this.FSMName=this.opts.prefixFsmName+y;this._stateDefinition=jQuery.extend(!0,{},d);this._originalstateDefinition=d;this.currentEvent=this.lastState=this.currentState="";this.pushStateList=[];this.processEventStatus="idle";this.pushEventList=[];this.myUIObject=a;this.listEvents={};this.currentDataEvent={};this.returnGeneralEventStatus=!0;void 0==this.opts.rootMachine&&(this.opts.rootMachine=
this);this.rootMachine=this.opts.rootMachine;this.parentMachine=void 0==this.opts.nextParent?null:this.opts.nextParent;this.opts.nextParent=this;this.childrenMachine=[];this.parentMachine&&this.parentMachine.childrenMachine.push(this);var e,c;f=d="";var l=g(document),h=!1,m=!1,b=[],k=!1;for(e in this._stateDefinition)for(c in"string"==typeof this._stateDefinition[e]&&(this._stateDefinition[e]=this._stateDefinition[this._stateDefinition[e]]),this._stateDefinition[e])"string"==typeof this._stateDefinition[e][c]&&
(this._stateDefinition[e][c]=this._stateDefinition[e][this._stateDefinition[e][c]]),this.rootMachine.listEvents[c]||"delegate_machines"==c||c==this.opts.startEvent?c==this.opts.startEvent&&(k=!0):(this.listEvents[c]=c,this!=this.rootMachine&&(this.rootMachine.listEvents[c]=c));e="";for(c in this.listEvents)e=c.split("_"),"attrchange"==e[0]&&(h=!0,b.push(c),"style"==e[1]&&2<e.length&&(m=!0)),d=d+f+c,f=" ";!a.selector&&a.attr("id")?a.selector="#"+a.attr("id"):a.selector="";if(h&&a.selector){var x,w=
{},n,v={},q,r,t;g(a.selector).attrchange({trackValues:!0,callback:function(a){0<=jQuery.inArray("attrchange",b)&&g(this).trigger("attrchange",a);0<=jQuery.inArray("attrchange_"+a.attributeName,b)&&g(this).trigger("attrchange_"+a.attributeName,{newValue:a.newValue,oldValue:a.oldValue});if("style"==a.attributeName&&m){x=a.newValue?a.newValue.split(";"):[];n=a.oldValue?a.oldValue.split(";"):[];for(r=0;r<x.length;r++)q=x[r].split(":"),2==q.length&&(w[q[0]]=q[1].replace(/^\s+/g,"").replace(/\s+$/g,""));
for(r=0;r<n.length;r++)q=n[r].split(":"),2==q.length&&(v[q[0]]=q[1].replace(/^\s+/g,"").replace(/\s+$/g,""));for(t in w)(void 0==v[t]||v[t]&&v[t]!=w[t])&&g(this).trigger("attrchange_style_"+A(t),{newValue:w[t],oldValue:v[t]})}}})}g.isWindow(a[0])&&(l=g(window));var p=this.rootMachine;if(""!=d)l.on(d,a.selector,function(a,b){p.returnGeneralEventStatus=!0;p.processEvent(a.type,arguments);return p.returnGeneralEventStatus});if(k){var u=this;l.on(this.opts.startEvent,a.selector,function(a,b){u.processEvent(a.type,
arguments)})}this._log("new fsm_manager:"+this.FSMName+"-"+a.selector,2)};m.prototype.InitManager=function(a){this._log("InitManager");this.currentState=void 0==a?"DefaultState":a;void 0==this._stateDefinition.DefaultState&&(this._stateDefinition.DefaultState={});this.parentMachine?(a=[],a[0]=p(this.myUIObject,this.opts.startEvent,null),this.processEvent(this.opts.startEvent,a,!0)):this.trigger(this.opts.startEvent)};m.prototype.processEvent=function(a,d,f){var e=this,c=this.currentState,l=this.currentUIEvent=
d[0];this.receivedEvent=a;this.currentDataEvent=d;this.currentEvent=l;var h=this.currentState,n=void 0==f?!1:!0;f=[];f[0]=p(this.myUIObject,"",null);this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> START Processing Event",2,1);if(1<d.length&&d[d.length-1].targetFSM&&d[d.length-1].targetFSM!=this&&(d[d.length-1].localMachine||d[d.length-1].targetFSM.rootMachine!=this.rootMachine))this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> not for the current machine ---\x3e exit",2);else if(1<d.length&&
d[d.length-1].localMachine&&this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> process event locally",2),this.subMachineName&&(!this.parentMachine._stateDefinition[this.parentMachine.currentState].delegate_machines||this.parentMachine._stateDefinition[this.parentMachine.currentState].delegate_machines&&!this.parentMachine._stateDefinition[this.parentMachine.currentState].delegate_machines[this.subMachineName]))this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> submachine can't run if the parent state is not active for the submachine ---\x3e exit",
2);else if(void 0==this._stateDefinition[c])this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> currentState does not exist!",2);else{if("enterState"==a||"exitState"==a)n=!0;if(this.myUIObject.is(l.currentTarget)||this.myUIObject.is(l.target)||this.myUIObject[0]==document||g.isWindow(l.currentTarget)||g.isWindow(l.target)){this.actualTarget=this.myUIObject[0]==document?g(document):g(l.currentTarget);var b=null,b=this._stateDefinition[c][a];if(0==n&&"idle"!=this.processEventStatus&&(void 0==b||
b&&void 0==b.how_process_event||b&&b.how_process_event&&void 0==b.how_process_event.immediate&&void 0==b.how_process_event.delay))this.pushEvent(a,d),this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Event pushed (lastevent)---\x3e "+this.lastevent+" --\x3e exit",2);else{this.lastevent=c+"-"+a;if(this._stateDefinition[c].delegate_machines){var k;for(aSubMachine in this._stateDefinition[c].delegate_machines)if(this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> delegate to submachine---\x3e "+
aSubMachine,2),k=this._stateDefinition[c].delegate_machines[aSubMachine],void 0==k.myFSM&&(this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> process submachine ---\x3e create FSM for the submachine "+aSubMachine,2),this._stateDefinition[c].delegate_machines[aSubMachine].myFSM=new m(this.myUIObject,k.submachine,this.opts),this._stateDefinition[c].delegate_machines[aSubMachine].myFSM.opts.FSMParent=this,this._stateDefinition[c].delegate_machines[aSubMachine].myFSM.subMachineName=aSubMachine),
"enterState"==a)""!=k.myFSM.currentState&&void 0!=k.no_reinitialisation&&0!=k.no_reinitialisation||k.myFSM.InitManager();else if("exitState"==a)f[0].type="exitMachine",k.myFSM.processEvent("exitMachine",f,!0),k.myFSM.cancelDelayedProcess();else{this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> process submachine  (event)---\x3e "+aSubMachine+"("+a+") Start",2);k.myFSM.processEvent(a,d);this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> process submachine  (event)---\x3e "+aSubMachine+"("+
a+") Processed",2);if(c!=this.currentState){this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> process submachine changed the current environment (event)",2);this.cleanExitProcess();this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> EXIT PROCESS",2,-1);return}if(k.myFSM._stateDefinition[k.myFSM.currentState][a]&&k.myFSM._stateDefinition[k.myFSM.currentState][a].prevent_bubble||k.myFSM._stateDefinition.DefaultState[a]&&k.myFSM._stateDefinition.DefaultState[a].prevent_bubble||a==this.opts.startEvent){this._log("processEvent: "+
this.FSMName+":"+c+":"+a+"-> submachine processed and exit due to prevent_bubble directive",2);this.cleanExitProcess();this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> submachine exit",2);this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> EXIT PROCESS",2,-1);return}}}if("DefaultState"==c||void 0==b){this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> take Event "+a+" configuration from DefaultState (not present in current state)",2);b=this._stateDefinition.DefaultState[a];void 0==
b&&0>["start","enterState","exitState","exitMachine"].indexOf(a)&&(this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> take Event "+a+" configuration from catchEvent",2),b=this._stateDefinition.DefaultState.catchEvent,this._stateDefinition.DefaultState[a]||(this._stateDefinition.DefaultState[a]=jQuery.extend(!0,{},b)));if(void 0==b){this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Event "+a+" does not exist and no catchEvent--\x3e will exit",2);this.cleanExitProcess();this._log("processEvent: "+
this.FSMName+":"+c+":"+a+"-> EXIT PROCESS",2,-1);return}h="DefaultState"}b.pushpop_state&&"PopState"==b.pushpop_state&&0<this.pushStateList.length&&(b.next_state=this.pushStateList[this.pushStateList.length-1]);b.pushpop_state_if_error&&"PopState"==b.pushpop_state_if_error&&0<this.pushStateList.length&&(b.next_state_if_error=this.pushStateList[this.pushStateList.length-1]);if(this.myUIObject.is(l.target)||this.myUIObject[0]==document||g.isWindow(l.currentTarget)||g.isWindow(l.target)||!b.process_on_UItarget||
1!=b.process_on_UItarget)if(b.UI_event_bubble&&0!=b.UI_event_bubble||(l.stopPropagation(),this.returnGeneralEventStatus=!1,this.rootMachine.returnGeneralEventStatus=!1),0==n&&b&&b.how_process_event&&b.how_process_event.delay)this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Event "+a+" delayed will exit",2),this.delayProcess(a,b.how_process_event.delay,d);else if(void 0==this._stateDefinition[h][a].EventIteration&&(this._stateDefinition[h][a].EventIteration=0),this._stateDefinition[h][a].EventIteration++,
this.EventIteration=this._stateDefinition[h][a].EventIteration,b.process_event_if&&0==eval(b.process_event_if))this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Event "+a+" event not allowed to process (process_event_if rule is not OK) will exit",2),b.propagate_event_on_refused&&(this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Event "+b.propagate_event_on_refused+" triggered on exit because of propagate_event_on_refused",2),this.trigger(b.propagate_event_on_refused,null,b.propagate_event_on_localmachine));
else{l=this.processEventStatus;this.processEventStatus="processing";h=!0;b.init_function&&(h=[].slice.call(d),h.unshift(b.properties_init_function),h=b.init_function.apply(this,h),this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> init_function done",2));if(0!=h&&b.pushpop_state)switch(b.pushpop_state){case "PushState":this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Push state to state "+this.currentState,2);this.pushStateList.push(this.currentState);break;case "PopState":0<this.pushStateList.length&&
(this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Pop state to state "+b.next_state,2),this.pushStateList.pop())}if(0!=h&&b.next_state&&c!=b.next_state&&(void 0==b.next_state_when&&void 0==b.next_state_on_target||b.next_state_when&&1==eval(b.next_state_when)||b.next_state_on_target&&1==this.subMachinesRespectTargets(a)))g.each(this._stateDefinition[this.currentState],function(a,b){"delegate_machines"!=a&&(e._stateDefinition[e.currentState][a].EventIteration=0)}),this.cancelDelayedProcess(),
f[0].type="exitState",a!=this.opts.startEvent&&this.processEvent("exitState",f,!0),this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Go to (see next_state) "+b.next_state,2),this.lastState=this.currentState,this.currentState=b.next_state,f[0].type="enterState",this.processEvent("enterState",f,!0),void 0!=b.propagate_event&&(b.propagate_event instanceof Array||(b.propagate_event=[b.propagate_event]),g.each(b.propagate_event,function(f,g){e._log("processEvent: "+e.FSMName+":"+c+":"+a+"-> trigger event (see propagate_event) ---\x3e "+
g,2);!0===g?e.trigger(a,d[1],b.propagate_event_on_localmachine):e.trigger(g,d[1],b.propagate_event_on_localmachine)}));else if(0!=h&&void 0!=b.propagate_event)b.propagate_event instanceof Array||(b.propagate_event=[b.propagate_event]),g.each(b.propagate_event,function(f,g){e._log("processEvent: "+e.FSMName+":"+c+":"+a+"-> trigger event (see propagate_event) ---\x3e "+g,2);!0===g?e.trigger(a,d[1],b.propagate_event_on_localmachine):e.trigger(g,d[1],b.propagate_event_on_localmachine)});else if(0==h&&
b.next_state_if_error){this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> error in init_function",2);if(b.pushpop_state_if_error)switch(b.pushpop_state_if_error){case "PushState":this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Push state to state "+this.currentState,2);this.pushStateList.push(this.currentState);break;case "PopState":0<this.pushStateList.length&&(this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Pop state to state "+b.next_state_if_error,2),this.pushStateList.pop())}this._log("processEvent: "+
this.FSMName+":"+c+":"+a+"-> Go to (see next_state_if_error) "+b.next_state_if_error,2);this.lastState=this.currentState;this.currentState=b.next_state_if_error;f[0].type="enterState";this.processEvent("enterState",f,!0)}else this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> nothing to do",2);b.out_function&&(h=[].slice.call(d),h.unshift(b.properties_out_function),h=b.out_function.apply(this,h),this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> out_function done",2));this.processEventStatus=
l}else this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> Event "+a+" does not address the correct UI target (see process_on_UItarget) will exit",2);this.cleanExitProcess()}}else this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> object not a good target  ---\x3e "+g(l.currentTarget).attr("id")+"---\x3e exit",2)}this._log("processEvent: "+this.FSMName+":"+c+":"+a+"-> EXIT PROCESS",2,-1)};m.prototype.cleanExitProcess=function(a,d){this.pushEventList.length&&("idle"==this.processEventStatus||
this.pushEventList.length>this.opts.maxPushEvent)&&this.popEvent()};m.prototype.pushEvent=function(a,d){this._log("pushEvent:  ---\x3e "+a);if(this.pushEventList.length>this.opts.maxPushEvent)this._log("pushEvent: too much events...  ---\x3e "+this.pushEventList.length,2);else{if(void 0==d||0==d.length||void 0==d[0].type){var f=[];f[0]=p(this.myUIObject,a);f[1]=d;d=f}this.pushEventList.push({anEvent:a,data:d});this._log("pushEvent: push  nb event ---\x3e "+this.pushEventList.length)}};m.prototype.popEvent=
function(){this._log("popEvent");if(0<this.pushEventList.length){anEventToProcess=this.pushEventList.shift();this._log("popEvent:"+anEventToProcess.anEvent,2);if(void 0==anEventToProcess||void 0==anEventToProcess.anEvent)return!1;this.processEvent(anEventToProcess.anEvent,anEventToProcess.data);return!0}this._log("popEvent void list");return!1};var z=0;m.prototype.delayProcess=function(a,d,f){this._log("delayProcess:  ---\x3e "+a);z++;var e=this.currentState;this._stateDefinition[this.currentState][a]||
(e="DefaultState");this._stateDefinition[e][a].how_process_event.DelayedProcessNames||(this._stateDefinition[e][a].how_process_event.DelayedProcessNames=[]);aDelayedProcessName=this.myUIObject.attr("id")+e+a+z;this._stateDefinition[e][a].how_process_event.DelayedProcessNames[aDelayedProcessName]=aDelayedProcessName;jQuery.doTimeout(aDelayedProcessName,d,fsm_manager_launchProcess,this,a,f)};m.prototype.cancelDelayedProcess=function(){this._log("cancelDelayedProcess");var a;for(aEvent in this._stateDefinition[this.currentState])if(a=
this.currentState,this._stateDefinition[a][aEvent]||(a="DefaultState"),a=this._stateDefinition[a][aEvent],a.how_process_event&&(void 0==a.how_process_event.preventcancel||1!=a.how_process_event.preventcancel)&&a.how_process_event.DelayedProcessNames){for(aDelayedProcessName in a.how_process_event.DelayedProcessNames)jQuery.doTimeout(aDelayedProcessName);a.how_process_event.DelayedProcessNames=[]}};m.prototype.trigger=function(a,d,f){f||(f=!1);var e=[];e[0]=p(this.myUIObject,a,null);e[1]=d;e[2]={targetFSM:this,
localMachine:f};f?this.processEvent(a,e):this.rootMachine.processEvent(a,e)};m.prototype.subMachinesRespectTargets=function(a){this._log("subMachinesRespectTargets:");var d=this._stateDefinition[this.currentState];a=d[a].next_state_on_target;var f=a.condition,e="||"==f?!1:!0,c=a.submachines;for(aSubMachine in c)if(c=-1<a.submachines[aSubMachine].target_list.indexOf(d.delegate_machines[aSubMachine].myFSM.currentState),void 0!=a.submachines[aSubMachine].condition&&"not"==a.submachines[aSubMachine].condition&&
(c=!c),"||"==f){if(e=e||c,1==e)break}else if("&&"==f){if(e=e&&c,0==e)break}else{this._log("operator unknown"+f);break}return e};var u="";m.prototype._log=function(a){!this.opts.debug||1<arguments.length&&arguments[1]>this.opts.LogLevel||1>=arguments.length&&3>this.opts.LogLevel||this.opts.logFSM&&0>this.opts.logFSM.indexOf(this.FSMName)||(2<arguments.length&&-1==arguments[2]&&(u=u.replace("  ","")),window.console&&console.log&&(console.log("[fsm] "+u+a),1==arguments[1]&&this.opts.AlertError&&alert(a),
2<arguments.length&&1==arguments[2]&&(u+="  ")))};fsm_manager_triggerMe=function(a,d,f){this._log("[fsm_manager_triggerMe]"+g(a.objectToTrigger).attr("id")+"-"+a.eventNameToTrigger);g(a.objectToTrigger).trigger(a.eventNameToTrigger)};fsm_manager_launchProcess=function(a,d,f){a._log("launchProcess:  ---\x3e "+d);a.processEvent(d,f,!0)};var n={};g.fn.iFSM=function(a,d){return this.each(function(){var f=new m(g(this),a,d);void 0!=g(this).attr("id")&&(void 0==n[g(this).attr("id")]&&(n[g(this).attr("id")]=
[]),n[g(this).attr("id")].push(f));d&&void 0!=d.initState?f.InitManager(d.initState):f.InitManager()})};g.fn.getFSM=function(a){if(1!=this.length||void 0==this.attr("id"))return[];if(void 0==a)return n[g(this).attr("id")];for(var d=null,f=0,e;f<n[g(this).attr("id")].length;f++)if(e=n[g(this).attr("id")][f],e._originalstateDefinition==a){d=e;break}return d}})(jQuery);