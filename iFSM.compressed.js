/*
 Intersel 2013-2014
 @fileoverview : iFSM : a finite state machine with jQuery
 @see {@link https://github.com/intersel/iFSM}
 @author : Emmanuel Podvin - emmanuel.podvin@intersel.fr
 @version : 1.6.14
 -----------------------------------------------------------------------------------------
*/
(function(f){function x(b){function c(a){return a.replace(/\-([a-z])/gi,function(a,b){return b.toUpperCase()})}for(var a=" -moz- -webkit- -o- -ms- -khtml-".split(" "),e=document.documentElement,d=0;d<a.length;d++){var f=c(a[d]+b);"Ms"==f.substr(0,2)&&(f="m"+f.substr(1));if(f in e.style)return f}}function p(b,c,a){var e={};e.data=a;e.target=b;e.currentTarget=b;e.type=c;e.stopPropagation=function(){return!0};return e}var u=0,l=window.fsm_manager=function(b,c,a){u+=1;void 0==a&&(a=null);this.opts=jQuery.extend({},
{debug:!1,LogLevel:2,AlertError:!1,maxPushEvent:100,startEvent:"start",prefixFsmName:"FSM_",logFSM:""},a||{});this.FSMName=this.opts.prefixFsmName+u;this._stateDefinition=jQuery.extend(!0,{},c);this._originalstateDefinition=c;this.currentEvent=this.currentState="";this.pushStateList=[];this.processEventStatus="idle";this.pushEventList=[];this.myUIObject=b;this.listEvents={};this.currentDataEvent={};this.returnGeneralEventStatus=!0;void 0==this.opts.rootMachine&&(this.opts.rootMachine=this);this.rootMachine=
this.opts.rootMachine;this.parentMachine=void 0==this.opts.nextParent?null:this.opts.nextParent;this.opts.nextParent=this;this.childrenMachine=[];this.parentMachine&&this.parentMachine.childrenMachine.push(this);var e,d;a=c="";var k=f(document),g=!1,m=!1,h=[],l=!1;for(e in this._stateDefinition)for(d in"string"==typeof this._stateDefinition[e]&&(this._stateDefinition[e]=this._stateDefinition[this._stateDefinition[e]]),this._stateDefinition[e])this.rootMachine.listEvents[d]||"delegate_machines"==d||
d==this.opts.startEvent?d==this.opts.startEvent&&(l=!0):(this.listEvents[d]=d,this!=this.rootMachine&&(this.rootMachine.listEvents[d]=d),"string"==typeof this._stateDefinition[e][d]&&(this._stateDefinition[e][d]=this._stateDefinition[e][this._stateDefinition[e][d]]));e="";for(d in this.listEvents)e=d.split("_"),"attrchange"==e[0]&&(g=!0,h.push(d),"style"==e[1]&&2<e.length&&(m=!0)),c=c+a+d,a=" ";if(null==b.selector||""==b.selector&&b.attr("id"))b.selector="#"+b.attr("id");if(g&&b.selector){var v,n=
{},p,t={},q,r,s;f(b.selector).attrchange({trackValues:!0,callback:function(a){0<=jQuery.inArray("attrchange",h)&&f(this).trigger("attrchange",a);0<=jQuery.inArray("attrchange_"+a.attributeName,h)&&f(this).trigger("attrchange_"+a.attributeName,{newValue:a.newValue,oldValue:a.oldValue});if("style"==a.attributeName&&m){v=a.newValue?a.newValue.split(";"):[];p=a.oldValue?a.oldValue.split(";"):[];for(r=0;r<v.length;r++)q=v[r].split(":"),2==q.length&&(n[q[0]]=q[1].replace(/^\s+/g,"").replace(/\s+$/g,""));
for(r=0;r<p.length;r++)q=p[r].split(":"),2==q.length&&(t[q[0]]=q[1].replace(/^\s+/g,"").replace(/\s+$/g,""));for(s in n)(void 0==t[s]||t[s]&&t[s]!=n[s])&&f(this).trigger("attrchange_style_"+x(s),{newValue:n[s],oldValue:t[s]})}}})}f.isWindow(b[0])&&(k=f(window));var w=this.rootMachine;if(""!=c)k.on(c,b.selector,function(a,b){w.returnGeneralEventStatus=!0;w.processEvent(a.type,arguments);return w.returnGeneralEventStatus});if(l){var y=this;k.on(this.opts.startEvent,b.selector,function(a,b){y.processEvent(a.type,
arguments)})}this._log("new fsm_manager:"+this.FSMName+"-"+b.selector,2)};l.prototype.InitManager=function(b){this._log("InitManager");this.currentState=void 0==b?"DefaultState":b;void 0==this._stateDefinition.DefaultState&&(this._stateDefinition.DefaultState={});null==this.parentMachine?this.trigger(this.opts.startEvent):(b=[],b[0]=p(this.myUIObject,this.opts.startEvent,null),this.processEvent(this.opts.startEvent,b,!0))};l.prototype.processEvent=function(b,c,a){var e=this,d=this.currentState,k=
this.currentUIEvent=c[0];this.currentDataEvent=c;this.currentEvent=k;var g=this.currentState,m=void 0==a?!1:!0;this._log("processEvent: anEvent (currentState) machine name ---\x3e "+b+"("+d+")-"+this.FSMName,2);if(1<c.length&&c[c.length-1].targetFSM&&c[c.length-1].targetFSM!=this&&c[c.length-1].targetFSM.rootMachine!=this.rootMachine)this._log("processEvent: not for the current machine ---\x3e exit",2);else if(void 0==this._stateDefinition[d])this._log("processEvent: currentState does not exist! ---\x3e ("+
d+")",1);else{if("enterState"==b||"exitState"==b)m=!0;if(this.myUIObject.is(k.currentTarget)||this.myUIObject.is(k.target)||this.myUIObject[0]==document||f.isWindow(k.currentTarget)||f.isWindow(k.target))if(this.actualTarget=this.myUIObject[0]==document?f(document):f(k.currentTarget),a=null,a=this._stateDefinition[d][b],!1==m&&"idle"!=this.processEventStatus&&(void 0==a||a&&void 0==a.how_process_event||a&&a.how_process_event&&void 0==a.how_process_event.immediate&&void 0==a.how_process_event.delay))this._log("processEvent: Push anEvent (lastevent)---\x3e "+
b+" ("+this.lastevent+")",2),this.pushEvent(b,c);else{this.lastevent=d+"-"+b;if(this._stateDefinition[d].delegate_machines){var h;for(aSubMachine in this._stateDefinition[d].delegate_machines)if(this._log("processEvent: delegate to submachine---\x3e "+aSubMachine),h=this._stateDefinition[d].delegate_machines[aSubMachine],void 0==h.myFSM&&(this._log("processEvent: process submachine ---\x3e create FSM for the submachine "+aSubMachine,2),this._stateDefinition[d].delegate_machines[aSubMachine].myFSM=
new l(this.myUIObject,h.submachine,this.opts),this._stateDefinition[d].delegate_machines[aSubMachine].myFSM.opts.FSMParent=this),"enterState"==b)""!=h.myFSM.currentState&&void 0!=h.no_reinitialisation&&!1!=h.no_reinitialisation||h.myFSM.InitManager();else if("exitState"==b)h.myFSM.trigger("exitMachine"),h.myFSM.cancelDelayedProcess();else if(this._log("processEvent: process submachine (event)---\x3e "+aSubMachine+"("+b+")",2),h.myFSM.processEvent(b,c),this._log("processEvent: process submachine (event)---\x3e "+
aSubMachine+"("+b+") processed",2),h.myFSM._stateDefinition[h.myFSM.currentState][b]&&h.myFSM._stateDefinition[h.myFSM.currentState][b].prevent_bubble||h.myFSM._stateDefinition.DefaultState[b]&&h.myFSM._stateDefinition.DefaultState[b].prevent_bubble||b==this.opts.startEvent){this._log("processEvent: submachine processed and direct exit ",2);this.cleanExitProcess();return}}if(void 0==a){a=this._stateDefinition.DefaultState[b];if(void 0==a){this._log("processEvent: Event does not exist? "+b+"("+g+")");
this.cleanExitProcess();return}g="DefaultState"}a.pushpop_state&&"PopState"==a.pushpop_state&&0<this.pushStateList.length&&(a.next_state=this.pushStateList[this.pushStateList.length-1]);a.pushpop_state_if_error&&"PopState"==a.pushpop_state_if_error&&0<this.pushStateList.length&&(a.next_state_if_error=this.pushStateList[this.pushStateList.length-1]);if(this.myUIObject.is(k.target)||this.myUIObject[0]==document||f.isWindow(k.currentTarget)||f.isWindow(k.target)||!a.process_on_UItarget||!0!=a.process_on_UItarget)if(a.UI_event_bubble&&
!1!=a.UI_event_bubble||(k.stopPropagation(),this.returnGeneralEventStatus=!1,this.rootMachine.returnGeneralEventStatus=!1),!1==m&&a&&a.how_process_event&&a.how_process_event.delay)this._log("processEvent: Event delayed "+b,2),this.delayProcess(b,a.how_process_event.delay,c),this.cleanExitProcess();else if(void 0==this._stateDefinition[g][b].EventIteration&&(this._stateDefinition[g][b].EventIteration=0),this._stateDefinition[g][b].EventIteration++,this.EventIteration=this._stateDefinition[g][b].EventIteration,
a.process_event_if&&!1==eval(a.process_event_if))this._log("processEvent: event not allowed to process "),a.propagate_event_on_refused&&(this._log("processEvent: propagate_event_on_refused ---\x3e "+b+"-"+a.propagate_event_on_refused),this.trigger(a.propagate_event_on_refused)),this.cleanExitProcess();else{k=this.processEventStatus;this.processEventStatus="processing";g=!0;a.init_function&&(g=[].slice.call(c),g.unshift(a.properties_init_function),g=a.init_function.apply(this,g),this._log("processEvent: anEvent / function done ---\x3e "+
b));m=[];m[0]=p(this.myUIObject,"",null);if(!1!=g&&a.pushpop_state)switch(a.pushpop_state){case "PushState":this._log("processEvent: Push state:"+this.currentState);this.pushStateList.push(this.currentState);break;case "PopState":0<this.pushStateList.length&&(this._log("processEvent: Pop state:"+a.next_state),this.pushStateList.pop())}if(!1!=g&&a.next_state&&d!=a.next_state&&(void 0==a.next_state_when&&void 0==a.next_state_on_target||a.next_state_when&&!0==eval(a.next_state_when)||a.next_state_on_target&&
!0==this.subMachinesRespectTargets(b)))e=this,f.each(this._stateDefinition[this.currentState],function(a,b){"delegate_machines"!=a&&(e._stateDefinition[e.currentState][a].EventIteration=0)}),this.cancelDelayedProcess(),m[0].type="exitState",b!=this.opts.startEvent&&this.processEvent("exitState",m,!0),this.currentState=a.next_state,m[0].type="enterState",this.processEvent("enterState",m,!0),this._log("processEvent: new state ---\x3e "+this.currentState),void 0!=a.propagate_event&&(a.propagate_event instanceof
Array||(a.propagate_event=[a.propagate_event]),f.each(a.propagate_event,function(a,d){e._log("processEvent: trigger event ---\x3e "+b+"-"+d);!0===d?e.trigger(b,c[1]):e.trigger(d,c[1])}));else if(!1!=g&&void 0!=a.propagate_event)a.propagate_event instanceof Array||(a.propagate_event=[a.propagate_event]),f.each(a.propagate_event,function(a,d){e._log("processEvent: trigger event ---\x3e "+b+"-"+d);!0===d?e.trigger(b,c[1]):e.trigger(d,c[1])});else if(!1==g&&a.next_state_if_error){this._log("processEvent: error state ---\x3e "+
this.currentState);if(a.pushpop_state_if_error)switch(a.pushpop_state_if_error){case "PushState":this._log("processEvent: Push state:"+this.currentState);this.pushStateList.push(this.currentState);break;case "PopState":0<this.pushStateList.length&&(this._log("processEvent: Pop state:"+a.next_state_if_error),this.pushStateList.pop())}this.currentState=a.next_state_if_error;this._log("processEvent: new state ---\x3e "+this.currentState);m[0].type="enterState";this.processEvent("enterState",m,!0)}a.out_function&&
(g=[].slice.call(c),g.unshift(a.properties_out_function),g=a.out_function.apply(this,g),this._log("processEvent: end out---\x3e "+b));this.processEventStatus=k;this.cleanExitProcess();this._log("processEvent: exit:"+b)}else this.cleanExitProcess()}else this._log("processEvent: object not a good target  ---\x3e "+f(k.currentTarget).attr("id"),2)}};l.prototype.cleanExitProcess=function(b,c){this.pushEventList.length&&("idle"==this.processEventStatus||this.pushEventList.length>this.opts.maxPushEvent)&&
this.popEvent()};l.prototype.pushEvent=function(b,c){this._log("pushEvent:  ---\x3e "+b);if(this.pushEventList.length>this.opts.maxPushEvent)this._log("pushEvent: too much events...  ---\x3e "+this.pushEventList.length,2);else{if(void 0==c||0==c.length||void 0==c[0].type){var a=[];a[0]=p(this.myUIObject,b);a[1]=c;c=a}this.pushEventList.push({anEvent:b,data:c});this._log("pushEvent: push  nb event ---\x3e "+this.pushEventList.length)}};l.prototype.popEvent=function(){this._log("popEvent");if(0<this.pushEventList.length){anEventToProcess=
this.pushEventList.shift();this._log("popEvent:"+anEventToProcess.anEvent,2);if(void 0==anEventToProcess||void 0==anEventToProcess.anEvent)return!1;this.processEvent(anEventToProcess.anEvent,anEventToProcess.data);return!0}this._log("popEvent void list");return!1};l.prototype.delayProcess=function(b,c,a){this._log("delayProcess:  ---\x3e "+b);jQuery.doTimeout(this.myUIObject.attr("id")+this._stateDefinition[this.currentState]+b,c,fsm_manager_launchProcess,this,b,a)};l.prototype.cancelDelayedProcess=
function(){this._log("cancelDelayedProcess:  ---\x3e ");var b;for(aEvent in this._stateDefinition[this.currentState])b=this._stateDefinition[this.currentState][aEvent],!b.how_process_event||void 0!=b.how_process_event.preventcancel&&!0==b.how_process_event.preventcancel||jQuery.doTimeout(this._stateDefinition[this.currentState]+aEvent)};l.prototype.trigger=function(b,c){var a=[];a[0]=p(this.myUIObject,b,null);a[1]=c;a[2]={targetFSM:this};this.rootMachine.processEvent(b,a)};l.prototype.subMachinesRespectTargets=
function(b){this._log("subMachinesRespectTargets:");var c=this._stateDefinition[this.currentState];b=c[b].next_state_on_target;var a=b.condition,e="||"==a?!1:!0,d=b.submachines;for(aSubMachine in d)if(d=-1<b.submachines[aSubMachine].target_list.indexOf(c.delegate_machines[aSubMachine].myFSM.currentState),void 0!=b.submachines[aSubMachine].condition&&"not"==b.submachines[aSubMachine].condition&&(d=!d),"||"==a){if(e=e||d,!0==e)break}else if("&&"==a){if(e=e&&d,!1==e)break}else{this._log("operator unknown"+
a);break}return e};l.prototype._log=function(b){!this.opts.debug||1<arguments.length&&arguments[1]>this.opts.LogLevel||1>=arguments.length&&3>this.opts.LogLevel||this.opts.logFSM&&0>this.opts.logFSM.indexOf(this.FSMName)||!window.console||!console.log||(console.log("[fsm] "+b),1==arguments[1]&&this.opts.AlertError&&alert(b))};fsm_manager_triggerMe=function(b,c,a){this._log("[fsm_manager_triggerMe]"+f(b.objectToTrigger).attr("id")+"-"+b.eventNameToTrigger);f(b.objectToTrigger).trigger(b.eventNameToTrigger)};
fsm_manager_launchProcess=function(b,c,a){b._log("launchProcess:  ---\x3e "+c);b.processEvent(c,a,!0)};var n={};f.fn.iFSM=function(b,c){return this.each(function(){var a=new l(f(this),b,c);void 0!=f(this).attr("id")&&(void 0==n[f(this).attr("id")]&&(n[f(this).attr("id")]=[]),n[f(this).attr("id")].push(a));c&&void 0!=c.initState?a.InitManager(c.initState):a.InitManager()})};f.fn.getFSM=function(b){if(1!=this.length||void 0==this.attr("id"))return[];if(void 0==b)return n[f(this).attr("id")];for(var c=
null,a=0,e=null;a<n[f(this).attr("id")].length;a++)if(e=n[f(this).attr("id")][a],e._originalstateDefinition==b){c=e;break}return c}})(jQuery);