/*
 Intersel 2013-2014
 @fileoverview : iFSM : a finite state machine with jQuery
 @see {@link https://github.com/intersel/iFSM}
 @author : Emmanuel Podvin - emmanuel.podvin@intersel.fr
 @version : 1.6.16
 -----------------------------------------------------------------------------------------
*/
(function(g){function x(a){function d(a){return a.replace(/\-([a-z])/gi,function(a,b){return b.toUpperCase()})}for(var c=" -moz- -webkit- -o- -ms- -khtml-".split(" "),e=document.documentElement,f=0;f<c.length;f++){var g=d(c[f]+a);"Ms"==g.substr(0,2)&&(g="m"+g.substr(1));if(g in e.style)return g}}function p(a,d,c){var e={};e.data=c;e.target=a;e.currentTarget=a;e.type=d;e.stopPropagation=function(){return!0};return e}var v=0,m=window.fsm_manager=function(a,d,c){v+=1;void 0==c&&(c=null);this.opts=jQuery.extend({},
{debug:!1,LogLevel:2,AlertError:!1,maxPushEvent:100,startEvent:"start",prefixFsmName:"FSM_",logFSM:""},c||{});this.FSMName=this.opts.prefixFsmName+v;this._stateDefinition=jQuery.extend(!0,{},d);this._originalstateDefinition=d;this.currentEvent=this.currentState="";this.pushStateList=[];this.processEventStatus="idle";this.pushEventList=[];this.myUIObject=a;this.listEvents={};this.currentDataEvent={};this.returnGeneralEventStatus=!0;void 0==this.opts.rootMachine&&(this.opts.rootMachine=this);this.rootMachine=
this.opts.rootMachine;this.parentMachine=void 0==this.opts.nextParent?null:this.opts.nextParent;this.opts.nextParent=this;this.childrenMachine=[];this.parentMachine&&this.parentMachine.childrenMachine.push(this);var e,f;c=d="";var l=g(document),h=!1,m=!1,b=[],k=!1;for(e in this._stateDefinition)for(f in"string"==typeof this._stateDefinition[e]&&(this._stateDefinition[e]=this._stateDefinition[this._stateDefinition[e]]),this._stateDefinition[e])"string"==typeof this._stateDefinition[e][f]&&(this._stateDefinition[e][f]=
this._stateDefinition[e][this._stateDefinition[e][f]]),this.rootMachine.listEvents[f]||"delegate_machines"==f||f==this.opts.startEvent?f==this.opts.startEvent&&(k=!0):(this.listEvents[f]=f,this!=this.rootMachine&&(this.rootMachine.listEvents[f]=f));e="";for(f in this.listEvents)e=f.split("_"),"attrchange"==e[0]&&(h=!0,b.push(f),"style"==e[1]&&2<e.length&&(m=!0)),d=d+c+f,c=" ";if(null==a.selector||""==a.selector&&a.attr("id"))a.selector="#"+a.attr("id");if(h&&a.selector){var w,u={},n,t={},q,r,s;g(a.selector).attrchange({trackValues:!0,
callback:function(a){0<=jQuery.inArray("attrchange",b)&&g(this).trigger("attrchange",a);0<=jQuery.inArray("attrchange_"+a.attributeName,b)&&g(this).trigger("attrchange_"+a.attributeName,{newValue:a.newValue,oldValue:a.oldValue});if("style"==a.attributeName&&m){w=a.newValue?a.newValue.split(";"):[];n=a.oldValue?a.oldValue.split(";"):[];for(r=0;r<w.length;r++)q=w[r].split(":"),2==q.length&&(u[q[0]]=q[1].replace(/^\s+/g,"").replace(/\s+$/g,""));for(r=0;r<n.length;r++)q=n[r].split(":"),2==q.length&&(t[q[0]]=
q[1].replace(/^\s+/g,"").replace(/\s+$/g,""));for(s in u)(void 0==t[s]||t[s]&&t[s]!=u[s])&&g(this).trigger("attrchange_style_"+x(s),{newValue:u[s],oldValue:t[s]})}}})}g.isWindow(a[0])&&(l=g(window));var p=this.rootMachine;if(""!=d)l.on(d,a.selector,function(a,b){p.returnGeneralEventStatus=!0;p.processEvent(a.type,arguments);return p.returnGeneralEventStatus});if(k){var y=this;l.on(this.opts.startEvent,a.selector,function(a,b){y.processEvent(a.type,arguments)})}this._log("new fsm_manager:"+this.FSMName+
"-"+a.selector,2)};m.prototype.InitManager=function(a){this._log("InitManager");this.currentState=void 0==a?"DefaultState":a;void 0==this._stateDefinition.DefaultState&&(this._stateDefinition.DefaultState={});null==this.parentMachine?this.trigger(this.opts.startEvent):(a=[],a[0]=p(this.myUIObject,this.opts.startEvent,null),this.processEvent(this.opts.startEvent,a,!0))};m.prototype.processEvent=function(a,d,c){var e=this,f=this.currentState,l=this.currentUIEvent=d[0];this.currentDataEvent=d;this.currentEvent=
l;var h=this.currentState,n=void 0==c?!1:!0;c=[];c[0]=p(this.myUIObject,"",null);this._log("processEvent: anEvent (currentState) machine name ---\x3e "+a+"("+f+")-"+this.FSMName,2);if(1<d.length&&d[d.length-1].targetFSM&&d[d.length-1].targetFSM!=this&&d[d.length-1].targetFSM.rootMachine!=this.rootMachine)this._log("processEvent: not for the current machine ---\x3e exit",2);else if(void 0==this._stateDefinition[f])this._log("processEvent: currentState does not exist! ---\x3e ("+f+")",1);else{if("enterState"==
a||"exitState"==a)n=!0;if(this.myUIObject.is(l.currentTarget)||this.myUIObject.is(l.target)||this.myUIObject[0]==document||g.isWindow(l.currentTarget)||g.isWindow(l.target)){this.actualTarget=this.myUIObject[0]==document?g(document):g(l.currentTarget);var b=null,b=this._stateDefinition[f][a];if(0==n&&"idle"!=this.processEventStatus&&(void 0==b||b&&void 0==b.how_process_event||b&&b.how_process_event&&void 0==b.how_process_event.immediate&&void 0==b.how_process_event.delay))this._log("processEvent: Push anEvent (lastevent)---\x3e "+
a+" ("+this.lastevent+")",2),this.pushEvent(a,d);else{this.lastevent=f+"-"+a;if(this._stateDefinition[f].delegate_machines){var k;for(aSubMachine in this._stateDefinition[f].delegate_machines)if(this._log("processEvent: delegate to submachine---\x3e "+aSubMachine),k=this._stateDefinition[f].delegate_machines[aSubMachine],void 0==k.myFSM&&(this._log("processEvent: process submachine ---\x3e create FSM for the submachine "+aSubMachine,2),this._stateDefinition[f].delegate_machines[aSubMachine].myFSM=
new m(this.myUIObject,k.submachine,this.opts),this._stateDefinition[f].delegate_machines[aSubMachine].myFSM.opts.FSMParent=this),"enterState"==a)""!=k.myFSM.currentState&&void 0!=k.no_reinitialisation&&0!=k.no_reinitialisation||k.myFSM.InitManager();else if("exitState"==a)c[0].type="exitMachine",k.myFSM.processEvent("exitMachine",c,!0),k.myFSM.cancelDelayedProcess();else if(this._log("processEvent: process submachine (event)---\x3e "+aSubMachine+"("+a+")",2),k.myFSM.processEvent(a,d),this._log("processEvent: process submachine (event)---\x3e "+
aSubMachine+"("+a+") processed",2),k.myFSM._stateDefinition[k.myFSM.currentState][a]&&k.myFSM._stateDefinition[k.myFSM.currentState][a].prevent_bubble||k.myFSM._stateDefinition.DefaultState[a]&&k.myFSM._stateDefinition.DefaultState[a].prevent_bubble||a==this.opts.startEvent){this._log("processEvent: submachine processed and direct exit ",2);this.cleanExitProcess();return}}if(void 0==b){b=this._stateDefinition.DefaultState[a];if(void 0==b){this._log("processEvent: Event does not exist? "+a+"("+h+")");
this.cleanExitProcess();return}h="DefaultState"}b.pushpop_state&&"PopState"==b.pushpop_state&&0<this.pushStateList.length&&(b.next_state=this.pushStateList[this.pushStateList.length-1]);b.pushpop_state_if_error&&"PopState"==b.pushpop_state_if_error&&0<this.pushStateList.length&&(b.next_state_if_error=this.pushStateList[this.pushStateList.length-1]);if(this.myUIObject.is(l.target)||this.myUIObject[0]==document||g.isWindow(l.currentTarget)||g.isWindow(l.target)||!b.process_on_UItarget||1!=b.process_on_UItarget)if(b.UI_event_bubble&&
0!=b.UI_event_bubble||(l.stopPropagation(),this.returnGeneralEventStatus=!1,this.rootMachine.returnGeneralEventStatus=!1),0==n&&b&&b.how_process_event&&b.how_process_event.delay)this._log("processEvent: Event delayed "+a,2),this.delayProcess(a,b.how_process_event.delay,d),this.cleanExitProcess();else if(void 0==this._stateDefinition[h][a].EventIteration&&(this._stateDefinition[h][a].EventIteration=0),this._stateDefinition[h][a].EventIteration++,this.EventIteration=this._stateDefinition[h][a].EventIteration,
b.process_event_if&&0==eval(b.process_event_if))this._log("processEvent: event not allowed to process "),b.propagate_event_on_refused&&(this._log("processEvent: propagate_event_on_refused ---\x3e "+a+"-"+b.propagate_event_on_refused),this.trigger(b.propagate_event_on_refused)),this.cleanExitProcess();else{l=this.processEventStatus;this.processEventStatus="processing";h=!0;b.init_function&&(h=[].slice.call(d),h.unshift(b.properties_init_function),h=b.init_function.apply(this,h),this._log("processEvent: anEvent / function done ---\x3e "+
a));if(0!=h&&b.pushpop_state)switch(b.pushpop_state){case "PushState":this._log("processEvent: Push state:"+this.currentState);this.pushStateList.push(this.currentState);break;case "PopState":0<this.pushStateList.length&&(this._log("processEvent: Pop state:"+b.next_state),this.pushStateList.pop())}if(0!=h&&b.next_state&&f!=b.next_state&&(void 0==b.next_state_when&&void 0==b.next_state_on_target||b.next_state_when&&1==eval(b.next_state_when)||b.next_state_on_target&&1==this.subMachinesRespectTargets(a)))e=
this,g.each(this._stateDefinition[this.currentState],function(a,b){"delegate_machines"!=a&&(e._stateDefinition[e.currentState][a].EventIteration=0)}),this.cancelDelayedProcess(),c[0].type="exitState",a!=this.opts.startEvent&&this.processEvent("exitState",c,!0),this.currentState=b.next_state,c[0].type="enterState",this.processEvent("enterState",c,!0),this._log("processEvent: new state ---\x3e "+this.currentState),void 0!=b.propagate_event&&(b.propagate_event instanceof Array||(b.propagate_event=[b.propagate_event]),
g.each(b.propagate_event,function(b,c){e._log("processEvent: trigger event ---\x3e "+a+"-"+c);!0===c?e.trigger(a,d[1]):e.trigger(c,d[1])}));else if(0!=h&&void 0!=b.propagate_event)b.propagate_event instanceof Array||(b.propagate_event=[b.propagate_event]),g.each(b.propagate_event,function(b,c){e._log("processEvent: trigger event ---\x3e "+a+"-"+c);!0===c?e.trigger(a,d[1]):e.trigger(c,d[1])});else if(0==h&&b.next_state_if_error){this._log("processEvent: error state ---\x3e "+this.currentState);if(b.pushpop_state_if_error)switch(b.pushpop_state_if_error){case "PushState":this._log("processEvent: Push state:"+
this.currentState);this.pushStateList.push(this.currentState);break;case "PopState":0<this.pushStateList.length&&(this._log("processEvent: Pop state:"+b.next_state_if_error),this.pushStateList.pop())}this.currentState=b.next_state_if_error;this._log("processEvent: new state ---\x3e "+this.currentState);c[0].type="enterState";this.processEvent("enterState",c,!0)}b.out_function&&(h=[].slice.call(d),h.unshift(b.properties_out_function),h=b.out_function.apply(this,h),this._log("processEvent: end out---\x3e "+
a));this.processEventStatus=l;this.cleanExitProcess();this._log("processEvent: exit:"+a)}else this.cleanExitProcess()}}else this._log("processEvent: object not a good target  ---\x3e "+g(l.currentTarget).attr("id"),2)}};m.prototype.cleanExitProcess=function(a,d){this.pushEventList.length&&("idle"==this.processEventStatus||this.pushEventList.length>this.opts.maxPushEvent)&&this.popEvent()};m.prototype.pushEvent=function(a,d){this._log("pushEvent:  ---\x3e "+a);if(this.pushEventList.length>this.opts.maxPushEvent)this._log("pushEvent: too much events...  ---\x3e "+
this.pushEventList.length,2);else{if(void 0==d||0==d.length||void 0==d[0].type){var c=[];c[0]=p(this.myUIObject,a);c[1]=d;d=c}this.pushEventList.push({anEvent:a,data:d});this._log("pushEvent: push  nb event ---\x3e "+this.pushEventList.length)}};m.prototype.popEvent=function(){this._log("popEvent");if(0<this.pushEventList.length){anEventToProcess=this.pushEventList.shift();this._log("popEvent:"+anEventToProcess.anEvent,2);if(void 0==anEventToProcess||void 0==anEventToProcess.anEvent)return!1;this.processEvent(anEventToProcess.anEvent,
anEventToProcess.data);return!0}this._log("popEvent void list");return!1};m.prototype.delayProcess=function(a,d,c){this._log("delayProcess:  ---\x3e "+a);jQuery.doTimeout(this.myUIObject.attr("id")+this._stateDefinition[this.currentState]+a,d,fsm_manager_launchProcess,this,a,c)};m.prototype.cancelDelayedProcess=function(){this._log("cancelDelayedProcess:  ---\x3e ");var a;for(aEvent in this._stateDefinition[this.currentState])a=this._stateDefinition[this.currentState][aEvent],!a.how_process_event||
void 0!=a.how_process_event.preventcancel&&1==a.how_process_event.preventcancel||jQuery.doTimeout(this._stateDefinition[this.currentState]+aEvent)};m.prototype.trigger=function(a,d){var c=[];c[0]=p(this.myUIObject,a,null);c[1]=d;c[2]={targetFSM:this};this.rootMachine.processEvent(a,c)};m.prototype.subMachinesRespectTargets=function(a){this._log("subMachinesRespectTargets:");var d=this._stateDefinition[this.currentState];a=d[a].next_state_on_target;var c=a.condition,e="||"==c?!1:!0,f=a.submachines;
for(aSubMachine in f)if(f=-1<a.submachines[aSubMachine].target_list.indexOf(d.delegate_machines[aSubMachine].myFSM.currentState),void 0!=a.submachines[aSubMachine].condition&&"not"==a.submachines[aSubMachine].condition&&(f=!f),"||"==c){if(e=e||f,1==e)break}else if("&&"==c){if(e=e&&f,0==e)break}else{this._log("operator unknown"+c);break}return e};m.prototype._log=function(a){!this.opts.debug||1<arguments.length&&arguments[1]>this.opts.LogLevel||1>=arguments.length&&3>this.opts.LogLevel||this.opts.logFSM&&
0>this.opts.logFSM.indexOf(this.FSMName)||!window.console||!console.log||(console.log("[fsm] "+a),1==arguments[1]&&this.opts.AlertError&&alert(a))};fsm_manager_triggerMe=function(a,d,c){this._log("[fsm_manager_triggerMe]"+g(a.objectToTrigger).attr("id")+"-"+a.eventNameToTrigger);g(a.objectToTrigger).trigger(a.eventNameToTrigger)};fsm_manager_launchProcess=function(a,d,c){a._log("launchProcess:  ---\x3e "+d);a.processEvent(d,c,!0)};var n={};g.fn.iFSM=function(a,d){return this.each(function(){var c=
new m(g(this),a,d);void 0!=g(this).attr("id")&&(void 0==n[g(this).attr("id")]&&(n[g(this).attr("id")]=[]),n[g(this).attr("id")].push(c));d&&void 0!=d.initState?c.InitManager(d.initState):c.InitManager()})};g.fn.getFSM=function(a){if(1!=this.length||void 0==this.attr("id"))return[];if(void 0==a)return n[g(this).attr("id")];for(var d=null,c=0,e=null;c<n[g(this).attr("id")].length;c++)if(e=n[g(this).attr("id")][c],e._originalstateDefinition==a){d=e;break}return d}})(jQuery);