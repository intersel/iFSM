<!DOCTYPE html>
<html>
<head>
    <title>iFSM in action! Bouncing Balls... </title>
	<meta charset="utf-8">
    <script type="text/javascript" src="../extlib/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="../extlib/jquery.dotimeout.js"></script>
    <script type="text/javascript" src="../extlib/jquery.attrchange.js"></script>
    <script type="text/javascript" src="../extlib/jcanvas.min.js"></script>
    <script type="text/javascript" src="../extlib/Vector2.js"></script>
    <script type="text/javascript" src="../iFSM.js"></script>
	<style type="text/css">
	  html {
	    font-family: Helvetica, Arial, sans-serif;
	  }
	  body {
	    padding: 0 20px;
	  }
	  button {
	    margin: 0 2px;
	    font-size: 20px;
	    border: 1px solid #333;
	    width: 100px;
	    text-shadow: 0 -1px 0 #333;
	    border-radius: 5px;
	  }
	  pre {
		font-size: 12px;
		background-color: black;
		color: green;
	  }
	</style>
    <script type="text/javascript">
    var CurrentMouseX=0;
    var CurrentMouseY=0;
    
    var behaviourSubMachines = 
	{
    	listOfForces:
    	{
			submachine : {
				doProcessForces : 
				{
					GroundAttraction: 
					{
						init_function:function(){
							var target = new Vector2(this.rootMachine.opts.Position.x,this.rootMachine.opts.heightScreen);
							var desired_velocity = target.minusNew(this.rootMachine.opts.Position).normalise();
							desired_velocity.multiplyEq(this.rootMachine.opts.MaxVelocityGA);
							this.rootMachine.opts.SteeringForce.plusEq(desired_velocity);
							
						},
					},
					FleeBalls: 
					{
						init_function:function(){
							if (CurrentMouseX==undefined) return;
							var target = new Vector2(CurrentMouseX,CurrentMouseY);
							var desired_velocity = this.rootMachine.opts.Position.minusNew(target).normalise();
							desired_velocity.multiplyEq(this.rootMachine.opts.MaxVelocity).multiplyEq(this.rootMachine.opts.Mass);
							this.rootMachine.opts.SteeringForce.plusEq(desired_velocity.minusEq(this.rootMachine.opts.Velocity));
							
						},
					},
					BallElasticity : 
					{
						init_function:function(){
							var aRatio=.95;
							if (this.rootMachine.opts.Mass>1) aRatio = aRatio / Math.sqrt(this.rootMachine.opts.Mass);
							if (this.rootMachine.opts.Position.x + this.rootMachine.opts.Velocity.x > this.rootMachine.opts.widthScreen || this.rootMachine.opts.Position.x + this.rootMachine.opts.Velocity.x < 0)
							{
								//this.rootMachine.opts.SteeringForce.x = -this.rootMachine.opts.SteeringForce.x;
								this.rootMachine.opts.Velocity.x=-this.rootMachine.opts.Velocity.x*aRatio;
							}
							if (this.rootMachine.opts.Position.y + this.rootMachine.opts.Velocity.y > this.rootMachine.opts.heightScreen || this.rootMachine.opts.Position.y + this.rootMachine.opts.Velocity.y < 0)
							{
								//this.rootMachine.opts.SteeringForce.y = -this.rootMachine.opts.SteeringForce.y;
								this.rootMachine.opts.Velocity.y=-this.rootMachine.opts.Velocity.y*aRatio;
							}
								
						},
					},			
					ComputePosition : 
					{
						init_function:function(){
							//truncate steering force to a maximum 
							this.rootMachine.opts.SteeringForce = this.rootMachine.opts.SteeringForce.truncate(this.rootMachine.opts.MaxSteeringForce);
							//the mass has some influence
							this.rootMachine.opts.SteeringForce.divideEq(Math.sqrt(this.rootMachine.opts.Mass));
							//compute the new velocity and truncate it to a maximum speed
							this.rootMachine.opts.Velocity.plusEq(this.rootMachine.opts.SteeringForce).truncate(this.rootMachine.opts.MaxSpeed);
							this.myUIObject.find('span#ForceX').html(this.rootMachine.opts.SteeringForce.x);
							this.myUIObject.find('span#ForceY').html(this.rootMachine.opts.SteeringForce.y);
							this.myUIObject.find('span#VelocityX').html(this.rootMachine.opts.Velocity.x);
							this.myUIObject.find('span#VelocityY').html(this.rootMachine.opts.Velocity.y);
							//compute the new position of the object
							this.rootMachine.opts.Position.plusEq(this.rootMachine.opts.Velocity);
							//this.rootMachine.opts.SteeringForce.reset(0,0);
							if (this.rootMachine.opts.Position.x >= this.rootMachine.opts.widthScreen) 
								this.rootMachine.opts.Position.x=this.rootMachine.opts.widthScreen;
							else if (this.rootMachine.opts.Position.x < 0) 
								this.rootMachine.opts.Position.x=0;
							if (this.rootMachine.opts.Position.y >= this.rootMachine.opts.heightScreen)
								this.rootMachine.opts.Position.y=this.rootMachine.opts.heightScreen;
							else if (this.rootMachine.opts.Position.y<0 ) 
								this.rootMachine.opts.Position.y=0;

						},
					},			
				},
				DefaultState:
				{
		    		doProcess: 
					{
						next_state:'doProcessForces',
//						propagate_event:['GroundAttraction','FleeBalls','ComputePosition','processed'],
						propagate_event:['GroundAttraction','FleeBalls','BallElasticity','ComputePosition','processed'],
					},
				},
			},
		},
	}; 
    
    var aGameObject = {
    	WaitProcess:
		{
    		doInitDraw: 
			{
				init_function:function(p,e,data){
					if (this.opts.initdraw) this.opts.initdraw(this);
					this.opts.speedOfGame = data.aFSM.opts.speedOfGame;
					if (this.opts.noAnimation) this.trigger('noAnimation');
					},
			},
    		doProcess: 
			{
				next_state:'Processing',
				propagate_event:true,
			},
			noAnimation: 
			{
				next_state:'noAnimation',
			},
    	},
    	noAnimation:
    	{
    		//do nothing now...
    		doDraw: 
			{
    			init_function:function(p,e,data){
    				//gives a direct feedback
    				this.opts.alertSenderData=data;
					if (this.opts.alertSenderData.aEvent) 
						this.opts.alertSenderData.aFSM.trigger(this.opts.alertSenderData.aEvent);
    				},
			},
			IsBouncing : 'doBounce', 
			doBounce : 
			{
			},
    	},
    	Processing:
		{
    		enterState: 
			{
				init_function:function(){
					//if (this.opts.process) this.opts.process(this);
					},
			},
			'delegate_machines'	: $.extend(true, {}, behaviourSubMachines),
			processed:
			{
				next_state:'WaitDraw',
			},
		},
		WaitDraw:
		{
			'delegate_machines'	: $.extend(true, {}, behaviourSubMachines),
			doDraw:
			{
				init_function:function(p,e,data){
					this.opts.alertSenderData=data;
					},
   				next_state:'Drawing',
   			},
		},
		Drawing:
		{
    		enterState: 
			{
				init_function:function(){
					if (this.opts.draw) this.opts.draw(this);
					this.trigger('drawDone');
					},
				next_state:'WaitEndOfDrawing',
			},
		},
		WaitEndOfDrawing:
		{
			drawDone:
			{
				init_function:function(){
					if (this.opts.alertSenderData.aEvent) 
						this.opts.alertSenderData.aFSM.trigger(this.opts.alertSenderData.aEvent);
				},
				next_state:'WaitProcess',
			},
		},
        DefaultState        :
        {
            start:
            {
				init_function:function(){
					this.opts.Position_original 	= $.extend(true, {},this.opts.Position);
					this.opts.Velocity_original		= $.extend(true, {},this.opts.Velocity);
					this.opts.SteeringForce_original= $.extend(true, {},this.opts.SteeringForce);
				},
            	next_state: 'WaitProcess',
            },
            reset:
            {
            	init_function:function(){
					this.opts.Position 		= $.extend(true, {},this.opts.Position_original);
					this.opts.Velocity		= $.extend(true, {},this.opts.Velocity_original);
					this.opts.SteeringForce	= $.extend(true, {},this.opts.SteeringForce_original);
            	}
            },
            click:
            {
            	init_function:function(){
            		alert('object clicked!');
            	}
            },
			IsBouncing : 
			{
				init_function:function(p,e,aFSM){
					if (!this.opts.Position) return;
					if (!aFSM.opts.Position) return;
					if (	(Math.abs(this.opts.Position.x - aFSM.opts.Position.x + aFSM.opts.Velocity.x/2) < (this.opts.width + aFSM.opts.width)/2)
						&&	(Math.abs(this.opts.Position.y - aFSM.opts.Position.y + aFSM.opts.Velocity.y/2) < (this.opts.height + aFSM.opts.height)/2)
						)
						aFSM.trigger('doBounce');
				},
			},
			doBounce : 
			{
				init_function:function(p,e){
					var aRatio=.45;
					if (this.opts.Mass>1) aRatio = aRatio / Math.sqrt(this.opts.Mass);
					this.opts.Velocity.x=-this.opts.Velocity.x*aRatio;
					this.opts.Velocity.y=-this.opts.Velocity.y*aRatio;
					var aVect=this.opts.Velocity.clone().normalise().multiplyEq(this.opts.width+1);
					this.opts.Position.plusEq(aVect);
					
				},
			}
            	
        }
    };
    
    var aGameRound = {
        	WaitStart:
    		{
        		enterState:
    			{
    				init_function:function()
   	    			{
						this._stateDefinition['NextRound']['doNextRound']['how_process_event'] = {delay: this.opts.speedOfGame};
	   					this.opts.nbFSMObjects = this.opts.gameFSMObjects.length;
	   					this.opts.counterIteration =0;
	   					this.trigger('displayGame');
    				}
    			},
   				StartStop: 
       			{
       				next_state:'PlayGame',
       				init_function:function(){
       					this.opts.lastcounterIteration=0;
    					this.trigger('displayFPS');
       				}
       			},
                displayFPS:'restartDisplayFPS',
                restartDisplayFPS:
                {
                },
                reset:
                {
					next_state:'Reset',
					pushpop_state: 'PushState'
				},
        	},
        	Reset:
        	{
        		enterState:
        		{
	   				init_function:function(){
						var myFSM=this;
						$.each(this.opts.gameFSMObjects,function(index,aFsmGame){
							aFsmGame.trigger('reset');
    						aFsmGame.trigger('doProcess');
    						aFsmGame.trigger('doDraw',{aFSM:myFSM,aEvent:'EndDoDraw'});
						});
	   				}
   				},
    			EndDoDraw:
    			{
    				next_state_when:'this.EventIteration>=this.opts.nbFSMObjects',
        			pushpop_state: 'PopState',
    			},
    			exitState:
    			{
    				propagate_event:'updateCanvas',
    			},
    		},
        	PlayGame:
    		{
        		enterState: 
    			{
    				init_function:function(){
    					this.trigger('displayGame');
    				},
    				next_state:'WaitEndProcessing',
    			},
    		},
    		WaitEndProcessing:
   			{
    			EndDoDraw:
    			{
    				next_state_when:'this.EventIteration>=this.opts.nbFSMObjects',
       				next_state:'NextRound',
    			},
    		},
    		NextRound:
   			{
    			enterState:
    			{
       				propagate_event:['updateCanvas','doNextRound'],
    			},
    			doNextRound:
    			{
       				how_process_event:{delay:10},
       				next_state:'PlayGame',
    			},
    		},
            DefaultState        :
            {
                start:
                {
                	init_function:function(){
    					var myFSM=this;
    					$.each(this.opts.gameFSMObjects,function(index,aFsmGame){
    						aFsmGame.trigger('doInitDraw',{aFSM:myFSM});
    					});
                	},
                	next_state: 'WaitStart',
                },
                StartStop:
                {
                	next_state:'WaitStart',
                },
                displayFPS:
                {
       				how_process_event:{delay:1000},
                	init_function:function(){
                		var aCount=this.opts.counterIteration-this.opts.lastcounterIteration;
                		this.opts.FPSCounter.html(aCount);
                		this.opts.lastcounterIteration=this.opts.counterIteration;
                		this.trigger('restartDisplayFPS');
                	}
                },
        		displayGame: 
    			{
    				init_function:function(){
    					var myFSM=this;
    					$.each(this.opts.gameFSMObjects,function(index,aFsmGame){
    						$.each(myFSM.opts.gameFSMObjects,function(index,aOtherFsmGame){
    							if (aFsmGame != aOtherFsmGame) aFsmGame.trigger('IsBouncing',aOtherFsmGame.getFSM());
    						});
    						aFsmGame.trigger('doProcess');
    						aFsmGame.trigger('doDraw',{aFSM:myFSM,aEvent:'EndDoDraw'});
    					});
    					this.opts.counterIteration++;
    					this.opts.counter.html(this.opts.counterIteration);
    				},
    			},
                updateCanvas:
                {
    				init_function:function(){
    					this.myUIObject.drawLayers();
    				},
                },
                restartDisplayFPS:
                {
                	propagate_event:'displayFPS',
                },
                mousemove:
                {
    				init_function:function(p,e){
                		CurrentMouseX = e.offsetX;
                		CurrentMouseY = e.offsetY;
					  	$('#status').html('mouse position: '+CurrentMouseX+'/'+CurrentMouseY);
    				}

                },
                mouseout:'mouseenter',
                mouseenter:
                {
    				init_function:function(p,e){
    					CurrentMouseX = undefined;
    					CurrentMouseY = undefined;
					  	$('#status').html('mouse position: '+e.type);
    				}

                },
                click:
                {
                	init_function:function(){
                		alert('canvas clicked!');
                	}
                }
            }
        };

    /**
     * @param BasicStatesUI
     *  handles simple click event, that should be transfered 'toWho' with the 'sendWhat' event sent
     *  it is configured with its option parameters:
     *  @param toWho: 		a iFSM machine
     *  @param sendWhat: 	an event name
     *  @example $('#OkConnectionButton').iFSM(BasicStatesUI,{onClic:{toWho:ClicClacMachine,sendWhat:'okDoConnection'}});
     */

    var BasicStatesUI =
    {
    		Displayed:
    		{
    			enterState:
    			{
    				init_function: 
    	            	function(parameters, event, data)
    	            	{
    						this.myUIObject.show();
    	            	}
    			}	
    		},
    		Hidden:
    		{
    			enterState:
    			{
    				init_function: 
    		        	function(parameters, event, data)
    		        	{
    						this.myUIObject.hide();
    		        	}
    			},	
    		},
    		DefaultState:
    		{
    			click:
    			{
    				init_function: 
    	            	function(parameters, event, data)
    	            	{
    						this.opts.onClick.toWho.trigger(this.opts.onClick.sendWhat);
    	            	}
    			},
    			show:
    			{
    				next_state: 'Displayed'
    			},
    			hide:
    			{
    				next_state: 'Hidden'
    			},
    			start:
    			{
    				process_event_if: 'this.opts.startState != undefined',
    				init_function: 
    	            	function(parameters, event, data)
    	            	{
    						this.currentState = this.opts.startState;
    	            	},
    	            propagate_event_on_refused:'defaultState',
    			
    			},
    			defaultState:
    			{
    				next_state:'Displayed',
    			}
    		},
    }
    $(document).ready(function() {
    	
        aBackGroundGame = $('#aBackground').iFSM(aGameObject,{
										canvas:$('#canvas'),
        								color: '#FAF7F8',
        								width: 400,
        								height: 300,
        								noAnimation:true,
        								initdraw:function(aFSM){
        									aFSM.opts.canvas.drawRect({
       										  layer: true,
       										  name: aFSM.FSMName+'_background',
        									  fillStyle: aFSM.opts.color,
        									  x: 0, y: 0,
        									  width: aFSM.opts.width,
        									  height: aFSM.opts.height,
        									  fromCenter: false,
        									});
        								},
        });
        
		function doDrawBall(aFSM){
			aFSM.opts.canvas
			.setLayer(aFSM.FSMName+'_ball',{
				x: aFSM.opts.Position.x, 
				y: aFSM.opts.Position.y,
				}
			);
		};
		
		function doInitDrawBall(aFSM)
		{
			aFSM.opts.canvas.drawEllipse({
				  fillStyle: aFSM.opts.color,
				  x: aFSM.opts.Position.x, 
				  y: aFSM.opts.Position.y,
				  width: aFSM.opts.width,
				  height: aFSM.opts.height,
				  layer: true,
				  name: aFSM.FSMName+'_ball',
				  click:
					  function(aLayer){
					  	aFSM.trigger('click',aLayer);
					  	},				  });
		}
		
        aBallGame = $('#aBall').iFSM(aGameObject,{
			canvas:$('#canvas'),
			color: '#770000',
			width: 20,
			height: 20,
			widthScreen:400,
			heightScreen:300,
			Position: new Vector2(100,20),//starting Position
			Velocity: new Vector2(5,-1), // starting Velocity
			SteeringForce:new Vector2(0,0), // 
			MaxVelocity:50, // maximum of velocity to flee in pixels
			MaxVelocityGA:1, // velocity to the ground 
			MaxSteeringForce:1, // maximum of general steering force in pixels
			MaxSpeed:100, // maximum of object speed in pixels
			Mass:1, // 
			initdraw:doInitDrawBall,
			draw:doDrawBall,
		});
      
        a2ndBallGame = $('#aSecondBall').iFSM(aGameObject,{
			canvas:$('#canvas'),
			color: '#007777',
			width: 30,
			height: 30,
			widthScreen:400,
			heightScreen:300,
			Position: new Vector2(20,50),
			Velocity: new Vector2(0,1),
			SteeringForce:new Vector2(0,0),
			MaxVelocity:50,
			MaxVelocityGA:1,
			MaxSteeringForce:.3,
			MaxSpeed:100,
			Mass:2,
			initdraw:doInitDrawBall,
			draw:doDrawBall,
		});
        a3rdBallGame = $('#aThirdBall').iFSM(aGameObject,{
			canvas:$('#canvas'),
			color: '#007700',
			width: 10,
			height: 10,
			widthScreen:400,
			heightScreen:300,
			Position: new Vector2(250,10),
			Velocity: new Vector2(2,0),
			SteeringForce:new Vector2(0,0),
			MaxVelocity:10,
			MaxVelocityGA:1,
			MaxSteeringForce:1,
			MaxSpeed:100,
			Mass:5,
			initdraw:doInitDrawBall,
			draw:doDrawBall,
		});
	   	var aObjectList=[aBackGroundGame,aBallGame,a2ndBallGame,a3rdBallGame];
	       
//   		var aObjectList=[aBackGroundGame,aBallGame];
        
        aGameFSM = $('#canvas').iFSM(aGameRound,{
			gameFSMObjects:aObjectList,
        	counter:$('#counter'),
        	FPSCounter:$('#FPSCounter'),
        	speedOfGame:20,
		});
        
        $('#StartStop').iFSM(BasicStatesUI,{onClick:{toWho:aGameFSM,sendWhat:'StartStop'}});
        $('#Reset').iFSM(BasicStatesUI,{onClick:{toWho:aGameFSM,sendWhat:'reset'}});
    });

    </script>
</head>
<body style="margin:20px;">
    <h1>The bouncing ball ....</h1>
    <p>this example shows a game loop, with bouncing balls as objects using canvas (jCanvas) with layers to display them</p>
    <p>The mouse makes the objects flee from it</p>
 	<section>
	    <div>
	        <canvas id="canvas" width="400" height="300">
	         This text is displayed if your browser 
	         does not support HTML5 Canvas.
	        </canvas>
			<button class="onoff" id="StartStop">Start/Stop Game</button>
			<button class="reset" id="Reset">Reset Game</button>
			<hr>
			<div>FrameCounter: <span id='counter'></span></div>	  
			<div>FPS: <span id='FPSCounter'></span></div>
			<div>Status: <span id='status'></span></div>
			<div id='aBackground'></div>
			<div class="ball" id='aBall'>
				<br>object 'aBall'<br>
				Force:<span id="ForceX"></span> -	<span id="ForceY"></span><br>	
				Velocity:<span id="VelocityX"></span> -	<span id="VelocityY"></span>	
			</div>
			<div class="ball" id='aSecondBall'>
				<br>object 'aSecondBall'<br>
				Force:<span id="ForceX"></span> -	<span id="ForceY"></span><br>	
				Velocity:<span id="VelocityX"></span> -	<span id="VelocityY"></span>	
			</div>
			<div class="ball" id='aThirdBall'>
				<br>object 'aThirdBall'<br>
				Force:<span id="ForceX"></span> -	<span id="ForceY"></span><br>	
				Velocity:<span id="VelocityX"></span> -	<span id="VelocityY"></span>	
			</div>
	    </div>
 	</section>    

<pre>
</pre>    
</body>
</html>
